#!/usr/bin/make -f

DEB_BUILD_MAINT_OPTIONS = hardening=+all
DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/buildflags.mk

#CPPFLAGS:=$(shell dpkg-buildflags --get CPPFLAGS)
#CFLAGS:=$(shell dpkg-buildflags --get CFLAGS) $(CPPFLAGS)
#CXXFLAGS:=$(shell dpkg-buildflags --get CXXFLAGS) $(CPPFLAGS)
#LDFLAGS:=$(shell dpkg-buildflags --get LDFLAGS)

DEB_DH_INSTALL_ARGS := --sourcedir=debian/tmp

export QT_SELECT = 5
QT_LIB_PREFIX = /usr/include/qt${QT_SELECT}
QT_LIBS = -I${QT_LIB_PREFIX}
QT_LIBS += -I${QT_LIB_PREFIX}/QtCore
QT_LIBS += -I${QT_LIB_PREFIX}/QtNetwork
QT_LIBS += -I${QT_LIB_PREFIX}/QtDBus

CPPFLAGS += -DRESIP_DIGEST_LOGGING
#CPPFLAGS += -DRESIP_FIXED_POINT
# this is just temporary, reSIProcate 1.9.x should not need this:
CPPFLAGS += -I/usr/include/sipxtapi
# these are also temporary, should be implemented in reSIProcate's build system, for sipXtapi
# with librecon:
CPPFLAGS += -D__pingtel_on_posix__ -D_linux_ -D_REENTRANT -D_FILE_OFFS
CPPFLAGS += -DDEFAULT_BRIDGE_MAX_IN_OUTPUTS=20
CPPFLAGS += -D__STDC_LIMIT_MACROS -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS
CPPFLAGS += -DRECON_SDP_ENCODING_NAMES_CASE_HACK
CPPFLAGS += ${QT_LIBS}
CPPFLAGS += -I/usr/include/telepathy-qt${QT_SELECT}
CPPFLAGS += -I/usr/include/soci
CPPFLAGS += -I/usr/include/mysql
CXXFLAGS += -fpermissive
CXXFLAGS += -I/usr/include/postgresql
LDFLAGS += -lcares

CFG_ARGS := -with-popt \
		--enable-ipv6 \
		--enable-dtls \
		--with-radcli \
		--with-ssl \
		--enable-assert-syslog \
		--with-c-ares \
		--with-mysql \
		--with-postgresql \
		--with-repro \
	        --with-return \
		--enable-repro-plugins \
		--with-python \
		--with-apps \
		--with-qpid-proton \
		--with-geoip \
	        --with-netsnmp

# on kfreebsd, sipxtapi is not available and recon can't be built
# upstream hopes to eliminate the dependency on sipxtapi in a future release
# so there is no attempt to port sipxtapi
# on sparc, libsrtp is not available (fails with a bus error during test cases)
ifeq ($(DEB_HOST_ARCH_OS),linux)
CFG_ARGS += --with-recon
CFG_ARGS += --with-telepathy
endif

PYVERSION=3
PYVERSION_EXACT=`python3 -V | cut -f2 -d' ' | cut -f1-2 -d.`

override_dh_auto_configure:
	#dh_auto_configure -- $(CFG_ARGS) DEPS_PYTHON_CFLAGS="`/usr/bin/python$(PYVERSION)-config --cflags`" DEPS_PYTHON_LIBS="`/usr/bin/python$(PYVERSION)-config --ldflags`" PYCXX_SRCDIR=/usr/share/python$(PYVERSION_EXACT)/CXX/Python3
	#cmake \
	dh_auto_configure -- \
    -DENABLE_LOG_REPOSITORY_DETAILS=OFF \
    -DRUN_GPERF=ON \
    -DCMAKE_BUILD_TYPE=Debug \
    -DCMAKE_CXX_FLAGS="${CPPFLAGS} ${CXXFLAGS}" \
    -DCMAKE_C_FLAGS="${CPPFLAGS} ${CFLAGS}" \
    -DWITH_C_ARES=ON \
    -DWITH_SSL=ON \
    -DUSE_POPT=ON \
    -DUSE_SIGCOMP=ON \
    -DUSE_FMT=OFF \
    -DVERSIONED_SONAME=ON \
    -DENABLE_ANDROID=OFF \
    -DUSE_IPV6=ON \
    -DUSE_DTLS=ON \
    -DPEDANTIC_STACK=OFF \
    -DUSE_MYSQL=ON \
    -DUSE_SOCI_POSTGRESQL=ON \
    -DUSE_SOCI_MYSQL=ON \
    -DUSE_POSTGRESQL=ON \
    -DUSE_MAXMIND_GEOIP=ON \
    -DRESIP_HAVE_RADCLI=ON \
    -DUSE_NETSNMP=ON \
    -DBUILD_REPRO=ON \
    -DBUILD_REPRO_DSO_PLUGINS=ON \
    -DBUILD_RETURN=ON \
    -DBUILD_REND=ON \
    -DBUILD_TFM=OFF \
    -DBUILD_ICHAT_GW=OFF \
    -DBUILD_TELEPATHY_CM=OFF \
    -DBUILD_RECON=ON \
    -DUSE_SRTP1=OFF \
    -DBUILD_RECONSERVER=ON \
    -DUSE_SIPXTAPI=ON \
    -DUSE_KURENTO=ON \
    -DUSE_GSTREAMER=ON \
    -DUSE_LIBWEBRTC=OFF \
    -DRECON_LOCAL_HW_TESTS=OFF \
    -DDEFAULT_BRIDGE_MAX_IN_OUTPUTS=20 \
    -DBUILD_P2P=OFF \
    -DBUILD_PYTHON=ON \
    -DPYCXX_SRCDIR=/usr/src/CXX \
    -DBUILD_QPID_PROTON=ON \
    -DRESIP_ASSERT_SYSLOG=ON
ifeq ($(DEB_HOST_ARCH_OS),kfreebsd)
# this is due to a problem with the test case rather than the stack itself
# upstream is investigating
	sed -i -e 's/assert.!failedToReceiveGoodMessage);//' resip/stack/test/testTcp.cxx
endif

override_dh_auto_build:
	#rm -f resip/stack/gen/*.cxx
	dh_auto_build --parallel

# let the test cases run
#override_dh_auto_test:
#	true

# force building in the pkgroot or it won't build
%:
	dh $@ --with autoreconf --builddirectory=.

override_dh_install:
	dh_install
	#	cp debian/repro.config-sample debian/repro/etc/repro/repro.config
	#	cp debian/reTurnServer.config-sample debian/resiprocate-turn-server/etc/reTurnServer.config
	sed -i \
		-e 's!UserAccountFile = users.txt!UserAccountFile = /etc/registrationAgent/users.txt!' \
		debian/registration-agent/etc/registrationAgent/registrationAgent.config
	install -D apps/registration-agent/registration-agent.init debian/registration-agent/etc/init.d/registration-agent

# workaround for lintian script-in-etc-init.d-not-registered-via-update-rc.d registration-agent
override_dh_installinit:
	dh_installinit -pregistration-agent --only-scripts
	dh_installinit --remaining
